<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ===== Meta ===== -->
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Neon Forge Events</title>
  <meta name="description" content="Neon Forge creates small-group events and multi-day adventures — shared stories, new friends, and big scenery."/>
  <meta name="theme-color" content="#0b0f14"/>

  <!-- ===== Font (matches your logo page) ===== -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>

  <!-- ===== Favicon (NF, cyan N & purple F) ===== -->
  <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 96 96'%3E
          %3Crect x='6' y='6' width='84' height='84' rx='22' fill='%230b0f14'/%3E
          %3Cdefs%3E
            %3Cfilter id='glowC' x='-50%25' y='-50%25' width='200%25' height='200%25'%3E%3CfeGaussianBlur stdDeviation='2' result='b'/%3E%3CfeMerge%3E%3CfeMergeNode in='b'/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E
            %3Cfilter id='glowP' x='-50%25' y='-50%25' width='200%25' height='200%25'%3E%3CfeGaussianBlur stdDeviation='2' result='b'/%3E%3CfeMerge%3E%3CfeMergeNode in='b'/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E
          %3C/defs%3E
          %3Cg text-anchor='middle' font-family='Space Grotesk, sans-serif' font-weight='700' font-size='46'%3E
            %3Ctext x='43%25' y='66%25' fill='%2306d7ff' filter='url(%23glowC)'%3EN%3C/text%3E
            %3Ctext x='62%25' y='66%25' fill='%239b5cff' filter='url(%23glowP)'%3EF%3C/text%3E
          %3C/g%3E
        %3C/svg%3E"/>

  <!-- ===== Styles (layout + logo) ===== -->
  <style>
    /* ---------------------------------------------
       1) THEME TOKENS — Neon Forge
       --------------------------------------------- */
    :root{
      --bg:#0b0f14;       /* midnight */
      --bg-2:#0f141b;     /* deep indigo */
      --ink:#e9f1ff;      /* cool paper white */
      --muted:#8ea1b5;    /* slate */
      --line:#17212b;     /* hairline on dark */

      --cyan:#06d7ff;     /* turquoise */
      --vio:#9b5cff;      /* violet */
      --neon: var(--cyan);/* alias so logo CSS works as-is */

      --s1:6px; --s2:10px; --s3:14px; --s4:18px;
      --s5:26px; --s6:38px; --s7:58px;
      --container: 1100px;
    }

    /* ---------------------------------------------
       2) GLOBAL
       --------------------------------------------- */
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      color:var(--ink);
      background:
        radial-gradient(1200px 900px at 50% 20%, #101620 0%, #0b0f14 40%, #05070a 100%),
        radial-gradient(900px 600px at 80% 10%, rgba(6,215,255,.10), transparent 60%),
        radial-gradient(900px 600px at 20% 80%, rgba(155,92,255,.10), transparent 60%);
      font-family:"Space Grotesk",system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
      line-height:1.6;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      text-rendering:optimizeLegibility;
    }
    /* soft grain */
    body::after{
      content:""; position:fixed; inset:0; pointer-events:none;
      background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 140 140' opacity='.05'>\
<filter id='n'><feTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='2' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0.5'/></feComponentTransfer></filter>\
<rect width='100%25' height='100%25' filter='url(%23n)'/></svg>");
      background-size:280px 280px; mix-blend-mode:soft-light;
    }

    a{ color:var(--cyan); text-decoration:none }
    a:hover{ text-decoration:underline }
    .muted{ color:var(--muted) }
    .wrap{ max-width:var(--container); margin:0 auto; padding:0 var(--s3) }

    @media (prefers-reduced-motion:reduce){
      *{ animation:none!important; transition:none!important }
    }

    /* ---------------------------------------------
       3) BANNERS
       --------------------------------------------- */
    .banner{ position:relative; isolation:isolate; overflow:hidden }

    header.banner{
      padding: clamp(54px, 8vw, 96px) 0 clamp(26px, 5vw, 42px);
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00));
      backdrop-filter: saturate(140%) blur(4px);
    }
    .hero{
      position:relative; z-index:1;
      max-width:var(--container); margin:0 auto; padding:0 var(--s3);
      display:grid; grid-template-columns:1fr; gap:var(--s2);
      text-align:center;
    }

    /* ====== LOGO STYLES ====== */
    .brand{
      font-weight:700; line-height:1;
      font-size:clamp(40px, 10vw, 120px);
      letter-spacing:.08em; text-transform:uppercase;
      color:var(--ink); white-space:nowrap;
    }
    .brand .ch{
      display:inline-block; position:relative; color:var(--ink);
      text-shadow:
        0 0 12px color-mix(in srgb, #9bdfff 40%, transparent),
        0 0 26px color-mix(in srgb, var(--neon) 55%, transparent);
      filter: drop-shadow(0 0 14px color-mix(in srgb, var(--neon) 50%, transparent));
    }
    /* cyan/turquoise */
    .brand .turq{
      color: var(--neon);
      text-shadow:
        0 0 14px color-mix(in srgb, var(--neon) 75%, transparent),
        0 0 36px color-mix(in srgb, var(--neon) 90%, transparent);
      filter: drop-shadow(0 0 18px color-mix(in srgb, var(--neon) 85%, transparent));
    }
    /* violet */
    .brand .violet{
      color: var(--vio);
      text-shadow:
        0 0 14px color-mix(in srgb, var(--vio) 75%, transparent),
        0 0 36px color-mix(in srgb, var(--vio) 90%, transparent);
      filter: drop-shadow(0 0 18px color-mix(in srgb, var(--vio) 85%, transparent));
    }

    @media (prefers-reduced-motion: no-preference){
      /* intro sweep (slower) */
      .intro .brand .ch{     animation: hueIntro 3.84s ease forwards }
      .intro .brand .turq{   animation: hueIntroTurq 3.84s ease forwards }
      .intro .brand .violet{ animation: hueIntroVio  3.84s ease forwards }

      /* steady pulse */
      .glow .brand .ch{ animation: pulse 2.4s ease-in-out infinite }
      .glow .brand .ch:nth-child(1){ animation-delay:0s }
      .glow .brand .ch:nth-child(2){ animation-delay:.05s }
      .glow .brand .ch:nth-child(3){ animation-delay:.10s }
      .glow .brand .ch:nth-child(4){ animation-delay:.15s }
      .glow .brand .ch:nth-child(5){ animation-delay:.30s } /* space */
      .glow .brand .ch:nth-child(6){ animation-delay:.35s } /* F/N depending */
      .glow .brand .ch:nth-child(7){ animation-delay:.40s } /* O */
      .glow .brand .ch:nth-child(8){ animation-delay:.45s } /* R */
      .glow .brand .ch:nth-child(9){ animation-delay:.50s } /* G */
      .glow .brand .ch:nth-child(10){ animation-delay:.55s } /* E */

      @keyframes pulse{
        0%,100%{
          opacity:.95;
          text-shadow: 0 0 8px currentColor, 0 0 26px currentColor;
          filter: drop-shadow(0 0 14px currentColor);
        }
        50%{
          opacity:1;
          text-shadow: 0 0 12px currentColor, 0 0 40px currentColor;
          filter: drop-shadow(0 0 22px currentColor);
        }
      }

      @keyframes hueIntro{
        0%   { color: var(--vio); }
        40%  { color: var(--neon); }
        100% { color: var(--ink); }
      }
      @keyframes hueIntroTurq{
        0%   { color: var(--vio); }
        40%  { color: var(--ink); }
        100% { color: var(--neon); }
      }
      @keyframes hueIntroVio{
        0%   { color: var(--neon); }
        40%  { color: var(--ink); }
        100% { color: var(--vio); }
      }
    }

    .hero-copy h1{
      margin: var(--s2) 0 2px;
      font-weight:700; letter-spacing:.06em;
      font-size: clamp(18px, 2.6vw, 22px);
      color: color-mix(in srgb, var(--ink) 92%, transparent);
    }
    .hero-copy p{
      margin:0; color:var(--muted);
      font-size: clamp(14px, 2.2vw, 16px);
    }

    /* ---------------------------------------------
       5) NAV
       --------------------------------------------- */
    nav{
      position:sticky; top:0; z-index:10;
      display:flex; gap:18px; justify-content:center; flex-wrap:wrap;
      background: rgba(10,14,20,.38);
      backdrop-filter: saturate(160%) blur(8px);
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
      padding: 10px 14px;
    }
    nav a{
      color: var(--ink); font-weight:700; letter-spacing:.04em;
      opacity:.92; position:relative; padding:4px 2px;
    }
    nav a::after{
      content:""; position:absolute; left:0; right:0; bottom:0;
      height:2px; background: linear-gradient(90deg, var(--cyan), var(--vio));
      transform: scaleX(0); transform-origin: left; transition: transform .25s ease;
      border-radius:2px;
    }
    nav a:hover{ opacity:1 }
    nav a:hover::after{ transform: scaleX(1) }

    /* ---------------------------------------------
       6) MAIN
       --------------------------------------------- */
    main{ max-width: 980px; margin: 28px auto; padding: 0 var(--s3) }
    .section{ margin: 28px 0 }
    .section h2{
      margin:0 0 2px;
      font-weight:700; letter-spacing:.06em;
      font-size: clamp(20px, 3vw, 28px);
      color: color-mix(in srgb, var(--ink) 94%, transparent);
      text-shadow: 0 0 10px rgba(155,92,255,.15);
    }
    .lead{ color:var(--muted) }

    .list{ margin-top: 12px }
    .item{ padding:18px 0; position:relative; transition: transform .25s ease, opacity .25s ease }
    .item + .item{ border-top:1px solid var(--line) }
    .item:hover{ transform: translateY(-1px) }

    .row{ display:grid; grid-template-columns:1fr; gap:0; align-items:center }
    .title{ font-weight:700; margin-block:14px }

    .meta{
      color: #a9bed1; font-size:14px;
      display:flex; flex-wrap:wrap; gap:4px 12px; align-items:baseline;
    }
    .meta > span{ white-space:nowrap }
    @media (max-width:420px){ .meta{ font-size:13px } }
    .meta--prog{ margin-top:6px }

    .status{
      display:inline-block; font-size:12px; padding:3px 10px; margin-left:8px;
      border-radius:999px; background: rgba(6,215,255,.12); color:#89eaff;
      border:1px solid rgba(6,215,255,.28);
    }
    .status.closed{
      background: rgba(155,92,255,.10);
      color:#c9adff; border-color: rgba(155,92,255,.26);
    }

    .thumb{
      width:100%; aspect-ratio:16/9; border-radius:14px; overflow:hidden;
      background:#0f141b; border:1px solid var(--line);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block }

    details{ margin-top:10px }
    summary{
      list-style:none; cursor:pointer; padding:8px 0;
      color: var(--ink); font-weight:700; letter-spacing:.04em;
      display:flex; align-items:center; gap:8px;
    }
    summary::-webkit-details-marker{ display:none }
    .chev{ transition:transform .2s }
    details[open] summary .chev{ transform:rotate(180deg) }
    .drawer{ padding:2px 0 6px }

    .bar{
      height:10px; background:#0f141b; border:1px solid var(--line);
      border-radius:999px; overflow:visible; margin:8px 0 10px; position:relative;
      box-shadow: inset 0 0 10px rgba(6,215,255,.08), inset 0 0 12px rgba(155,92,255,.06);
    }
    .bar > span{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, var(--cyan), var(--vio));
      box-shadow: 0 0 12px rgba(6,215,255,.35), 0 0 22px rgba(155,92,255,.25);
      border-radius:999px;
    }

    .interest{ margin-top:10px }
    .interest label{ display:block; font-weight:700; margin:10px 0 6px }
    .interest input, .interest select{
      width:100%; padding:12px 12px; border-radius:12px;
      border:1px solid var(--line); background:#0f1417; color:#dce7f7;
      outline:none; transition: box-shadow .25s ease, border-color .25s ease;
    }
    .interest input::placeholder{ color:#7f8ea0 }
    .interest input:focus, .interest select:focus{
      border-color: color-mix(in srgb, var(--cyan) 70%, transparent);
      box-shadow: 0 0 0 6px rgba(6,215,255,.12);
    }

    .row2{ display:grid; grid-template-columns:1fr; gap:10px }
    @media (min-width:600px){ .row2{ grid-template-columns:1fr 1fr } }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button{ -webkit-appearance:none!important; margin:0 }
    input[type=number]{ appearance:textfield!important }

    .send{
      margin-top:10px; background:none; border:0; padding:0; font:inherit; cursor:pointer;
      color:var(--ink); position:relative; display:inline-block; font-weight:700;
    }
    .send .arrow{ display:inline-block; transform:translateX(0); transition:transform .25s ease }
    .send:hover .arrow{ transform:translateX(3px) }

    .okmsg{ color:#89eaff; margin-top:8px }
    .errmsg{ color:#ff8b6b; margin-top:8px }

    footer.banner{
      padding: 34px 0 42px;
      border-top:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.00), rgba(255,255,255,.02));
      backdrop-filter: saturate(140%) blur(4px);
    }
    footer .inner{
      max-width:var(--container); margin:0 auto; text-align:center; color:#c8d6e6;
      position:relative; z-index:1;
    }
    #signinDot{
      background:none; border:0; color:var(--ink); cursor:pointer;
      font-size:16px; line-height:1; padding:2px 8px; border-radius:999px; margin-left:6px;
    }
    #signinDot:focus-visible{ outline:3px solid rgba(6,215,255,.35); outline-offset:2px }
    #authMsg{ display:block; min-height:16px; color:#a4b9cf }

    @media (min-width:1024px){
      main{ max-width: 940px }
      .thumb{ max-height: 380px; aspect-ratio:auto }
      .thumb img{ object-fit:cover; object-position: center 40% }
    }
  </style>
</head>

<body>
  <!-- Force HTTPS on production domain -->
  <script>
    (function () {
      const host = location.hostname;
      const isNeon = host === 'neonforge.co.uk' || host === 'www.neonforge.co.uk';
      if (isNeon && location.protocol !== 'https:') {
        location.replace('https://' + host + location.pathname + location.search + location.hash);
      }
    })();
  </script>

  <!-- =========================
       HERO (with revised logo)
       ========================= -->
  <header class="banner">
    <div class="hero">
      <h1 class="brand" aria-label="Neon Forge">
        <span class="ch turq">N</span><span class="ch">E</span><span class="ch">O</span><span class="ch">N</span>
        <span class="ch">&nbsp;</span>
        <span class="ch violet">F</span><span class="ch">O</span><span class="ch">R</span><span class="ch">G</span><span class="ch">E</span>
      </h1>
      <div class="hero-copy">
        <h1>Gather. Explore. Celebrate.</h1>
        <p>Small-group events & multi-day adventures</p>
      </div>
    </div>
  </header>

  <!-- =========================
       NAVIGATION
       ========================= -->
  <nav>
    <a href="#about">About</a>
    <a href="#tours">Experiences</a>
    <a href="#events">Signature Events</a>
    <a href="#contact">Contact</a>
  </nav>

  <!-- =========================
       MAIN
       ========================= -->
  <main>
    <!-- ABOUT -->
    <section id="about" class="section">
      <h2>About</h2>
      <p class="muted">
        Neon Forge is about bringing people together around memorable places and easy company.
        We design days and long weekends that feel relaxed, well-looked-after and a little electric — the kind you talk about afterwards.
      </p>
      <p class="muted">
        Sometimes that’s a small group in a minibus, sometimes a bigger crew with a few moving parts, and sometimes it’s a base with time to roam.
        Whatever the format, the mood stays the same: safe, friendly and welcoming.
      </p>
      <p class="muted">
        Not every plan fits everyone — and that’s fine. Some prefer a quiet wander with coffee stops; others want viewpoints and fresh air.
        Pick what suits you and we’ll handle the rest.
      </p>
      <p class="muted">
        The weather has a mind of its own, but the stories, company and scenery make it worth it.
        That’s Neon Forge — shared time, good laughs and reasons to come back.
      </p>
    </section>

    <!-- EXPERIENCES -->
    <section id="tours" class="section">
      <h2>Experiences & Multi-Day Tours</h2>
      <div id="toursList" class="list">
        <div class="lead">Loading experiences…</div>
      </div>
    </section>

    <!-- EVENTS -->
    <section id="events" class="section">
      <h2>Signature Events</h2>
      <div id="eventsList" class="list">
        <div class="lead">Loading events…</div>
      </div>
    </section>

    <!-- CONTACT -->
    <section id="contact" class="section">
      <h2>Contact</h2>
      <p class="muted">
        The best way to reach us is by email at
        <a href="mailto:info@neonforge.co.uk">info@neonforge.co.uk</a>.
        We’re a small team out on the road a lot, so we don’t run a live phone line.
        Email is monitored throughout the day and we aim to reply within a couple of hours.
      </p>
      <p class="muted">
        If an event has limited spaces, don’t worry — your place in the queue is based on the
        <strong>timestamp of your email</strong>. That way it’s fair and there’s no need to panic.
      </p>
      <p class="muted">
        A valid email address is essential because confirmations, payment links and any paperwork are sent by email.
        We also ask for a phone number as a backup, but we’ll only use it if we can’t reach you by email.
      </p>
      <p class="muted">
        Ask anything — dates, accessibility, what to bring — and we’ll help you pick the day that suits you.
      </p>
    </section>
  </main>

  <!-- =========================
       FOOTER
       ========================= -->
  <footer class="banner">
    <div class="inner">
      © <span id="yr"></span> Neon Forge
      <button id="signinDot" title="Staff" aria-label="Staff sign-in">•</button>
      <small id="authMsg" aria-live="polite"></small>
    </div>
  </footer>

  <!-- =========================
       APP SCRIPT
       ========================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, collection, getDocs, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA9EdglxWetAv81qe1GnwlMf7HbPccjXxQ",
      authDomain: "tourthelakes-1e165.firebaseapp.com",
      projectId: "tourthelakes-1e165",
      storageBucket: "tourthelakes-1e165.firebasestorage.app",
      messagingSenderId: "470758171431",
      appId: "1:470758171431:web:f06dd39b0f15b63b2bff02",
      measurementId: "G-W6JY1LZXTP"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const provider = new GoogleAuthProvider();
    const ALLOWED = ["info@tourthelakes.com"];

    const $ = id => document.getElementById(id);
    const authMsg = $("authMsg");
    const fmtUK = s => s ? s.split("-").reverse().join("/") : "";
    const isClosed = (d,c)=>{ const n=new Date(); return n>new Date(c)||n>new Date(d); };
    const daysUntil = s => {
      if(!s) return null;
      const n=new Date(); n.setHours(0,0,0,0);
      const d=new Date(s); d.setHours(0,0,0,0);
      return Math.round((d-n)/86400000);
    };
    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
    }
    function renderDescription(s=""){
      const safe = escapeHtml(s.trim());
      if (!safe) return "<p></p>";
      return safe.split(/\n{2,}/).map(p => `<p>${p.replace(/\n/g,"<br>")}</p>`).join("");
    }

    function item(col, id, data){
      const closed = isClosed(data.date, data.cutoff) || !!data.closed;
      const el = document.createElement("div");
      el.className = "item";

      const d = daysUntil(data.cutoff);
      const extra = (!closed && d != null && d > 0) ? ` · ${d} day${d === 1 ? "" : "s"} to cutoff` : "";
      const status = closed
        ? `<span class="status closed">Closed</span>`
        : `<span class="status">Open${extra}</span>`;

      const img = data.imageUrl
        ? `<div class="thumb"><img src="${data.imageUrl}" alt=""></div>`
        : ``;

      el.innerHTML = `
        ${img}
        <div class="row">
          <div class="title">${escapeHtml(data.title || "")} ${status}</div>
          <div class="meta">
            <span><strong>Date:</strong>&nbsp;${fmtUK(data.date)}</span>
            &nbsp; &middot; &nbsp;
            <span><strong>Cutoff:</strong>&nbsp;${fmtUK(data.cutoff)}</span>
            &nbsp; &middot; &nbsp;
            <span><strong>Price:</strong>&nbsp;£${Number(data.price||0).toFixed(0)}</span>
          </div>
        </div>

        <details>
          <summary><span class="chev">▾</span> Details</summary>
          <div class="drawer">
            <p><strong>About this ${col.slice(0,-1)}:</strong></p>
            ${renderDescription(data.description || "")}
            ${
              (data.paymentInfo && data.paymentInfo.trim())
                ? `<p><strong>Payment info:</strong></p>${renderDescription(data.paymentInfo)}`
                : ``
            }
            <div id="prog-${col}-${id}" style="margin-top:10px"></div>

            <form class="interest" id="form-${col}-${id}">
              <div class="row2">
                <div>
                  <label for="n-${id}">Name</label>
                  <input id="n-${id}" name="name" type="text" required maxlength="100"
                         autocomplete="name" placeholder="Full name"
                         title="Please enter your full name"/>
                </div>
                <div>
                  <label for="e-${id}">Email *</label>
                  <input id="e-${id}" name="email" type="email" required
                         autocomplete="email" placeholder="name@example.com"
                         title="Please enter a valid email address"/>
                </div>
              </div>

              <div class="row2">
                <div>
                  <label for="p-${id}">Phone</label>
                  <input id="p-${id}" name="phone" type="tel" placeholder="+44 1234 567890"
                         pattern="^\\+?[0-9\\s\\-]{7,20}$" inputmode="tel" autocomplete="tel"/>
                </div>
                <div>
                  <label for="s-${id}">Places</label>
                  <input id="s-${id}" name="seats" type="number" inputmode="numeric" pattern="[0-9]*"
                         min="1" max="99" step="1" required value="1"/>
                </div>
              </div>

              <button type="submit" class="send" ${closed ? "disabled" : ""}>
                Send <span class="arrow">→</span>
              </button>

              <div class="okmsg" id="ok-${col}-${id}" style="display:none">
                Thanks — we’ve got your interest. We’ll be in touch.
              </div>
              <div class="errmsg" id="er-${col}-${id}" style="display:none">
                Could not send. Please try again.
              </div>
            </form>
          </div>
        </details>
      `;

      const details  = el.querySelector("details");
      const progHost = el.querySelector(`#prog-${col}-${id}`);

      const cap = Number(data.capacity || 0);
      const min = Number(data.minNeeded ?? 20);

      async function updateProgress(){
        if (!cap) { progHost.innerHTML = ""; return; }
        let booked = 0, interested = 0;
        try{
          const snap = await getDocs(collection(db, col, id, "interests"));
          snap.forEach(s=>{
            const x = s.data();
            let seats = parseInt(x.seats, 10);
            if (isNaN(seats) || seats <= 0) seats = 1;
            const st = (x.status || "pending").toLowerCase();
            interested += seats;
            if (st === "confirmed") booked += seats;
          });
        }catch(e){ console.error(e); }
        const pct    = cap ? Math.min(100, Math.round((booked / cap) * 100)) : 0;
        const minPct = cap ? Math.min(100, Math.round((min    / cap) * 100)) : 0;

        progHost.innerHTML = `
          <div class="meta">
            <strong>Capacity:</strong> ${cap}
            &nbsp; · &nbsp; <strong>Min to run:</strong> ${min}
            &nbsp; · &nbsp; <strong>Booked:</strong> ${booked}
            &nbsp; · &nbsp; <strong>Interested:</strong> ${interested}
          </div>
          <div class="bar">
            <span style="width:${pct}%"></span>
            <div style="
              position:absolute; left:${minPct}%; top:50%; transform:translate(-50%,-50%);
              width:0;height:0; border-left:6px solid transparent; border-right:6px solid transparent;
              border-bottom:8px solid #a9bed1;
            "></div>
          </div>
          <div class="meta">Fill ${pct}% &nbsp; • &nbsp; <span class="muted">▲ = minimum</span></div>
        `;
      }

      details.addEventListener("toggle", ()=>{ if (details.open) updateProgress(); });
      updateProgress();

      const seats = el.querySelector(`#s-${id}`);
      seats.addEventListener("input", () => {
        let v = seats.value.replace(/\D/g, "");
        seats.value = v === "" ? "" : String(Math.max(1, Math.min(99, parseInt(v, 10))));
      });
      seats.addEventListener("blur", () => {
        const n = parseInt(seats.value, 10);
        seats.value = isNaN(n) ? "1" : String(Math.max(1, Math.min(99, n)));
      });

      const form = el.querySelector(`#form-${col}-${id}`);
      const ok   = el.querySelector(`#ok-${col}-${id}`);
      const er   = el.querySelector(`#er-${col}-${id}`);

      form.addEventListener("submit", async (e)=>{
        if (!form.checkValidity()) { form.reportValidity(); e.preventDefault(); return; }
        e.preventDefault(); ok.style.display="none"; er.style.display="none";
        const fd = new FormData(form);
        try{
          await addDoc(collection(db, col, id, "interests"), {
            name: (fd.get("name")+"").trim(),
            email:(fd.get("email")+"").trim(),
            phone:(fd.get("phone")+"").trim(),
            seats:Number(fd.get("seats")||1),
            status:"pending",
            createdAt: serverTimestamp()
          });
          form.reset(); ok.style.display="block";
          if (details.open) updateProgress();
        }catch(err){ console.error(err); er.style.display="block"; }
      });

      return el;
    }

    async function renderList(col, mountId){
      const mount = document.getElementById(mountId);
      mount.innerHTML = `<div class="lead">Loading…</div>`;
      try{
        const qy = query(collection(db, col), orderBy("date","asc"));
        const snap = await getDocs(qy);
        const items = [];
        snap.forEach(d=> items.push({ id:d.id, data:d.data() }));

        const open   = items.filter(x=>!isClosed(x.data.date, x.data.cutoff) && !x.data.closed);
        const closed = items.filter(x=> isClosed(x.data.date, x.data.cutoff) || x.data.closed);

        mount.innerHTML = "";
        [...open,...closed].forEach(({id,data})=> mount.appendChild(item(col,id,data)));
        if (!items.length) mount.innerHTML = `<div class="lead">No ${col} yet.</div>`;
      }catch(e){
        console.error(e);
        mount.innerHTML = `<div class="lead">Could not load ${col}.</div>`;
      }
    }
    renderList("tours","toursList");
    renderList("events","eventsList");

    async function openIfAllowed(user){
      const email = user?.email ?? "";
      if (["info@tourthelakes.com"].includes(email)){
        window.open("admin.html","_blank","noopener");
      } else if (user){
        authMsg.textContent = "Not authorised";
        setTimeout(()=>authMsg.textContent="", 3000);
        await signOut(auth);
      }
    }
    async function doSignIn(){
      if (auth.currentUser) return openIfAllowed(auth.currentUser);
      try{
        const res = await signInWithPopup(auth, provider);
        await openIfAllowed(res.user);
      }catch(err){
        if (err?.code==='auth/operation-not-supported-in-this-environment' || err?.code==='auth/popup-blocked'){
          await signInWithRedirect(auth, provider);
        }else{
          console.error(err);
          authMsg.textContent = "Sign in failed";
          setTimeout(()=>authMsg.textContent="", 3000);
        }
      }
    }
    document.getElementById("signinDot").addEventListener("click", doSignIn);
    getRedirectResult(auth).then(res => { if (res?.user) return openIfAllowed(res.user); }).catch(console.error);
  </script>

  <!-- Footer year + theme-color sync + one-time intro->glow -->
  <script>
    document.getElementById('yr').textContent = new Date().getFullYear();
    const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
    document.querySelector('meta[name="theme-color"]').setAttribute('content', bg);

    const root = document.documentElement;
    const INTRO_MS = 3840;
    root.classList.add('intro');
    setTimeout(()=> {
      root.classList.remove('intro');
      root.classList.add('glow');
    }, INTRO_MS + 120);
  </script>
</body>
</html>
